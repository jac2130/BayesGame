// requires shapeLib.js

function makeDropDownArrow()
{
    var dropDownArrow = Object.create(Widget);
    var arrowShape = new createjs.Shape();
    var graphics = arrowShape.graphics.setStrokeStyle(1);
    graphics.beginStroke("#666").moveTo(0, 0).lineTo(2, 4).lineTo(4, 0);
    graphics.endStroke();
    arrowShape.x = arrowShape.regX = 0;
    arrowShape.y = arrowShape.regY = 0;
    dropDownArrow.shape = arrowShape;
    return dropDownArrow;
}

var DropDownMenu = Object.create(Widget);

function makeDropDownMenu(choices, width, height, color, defaultMessage)
{
    var dropDownMenu = Object.create(DropDownMenu);
    dropDownMenu.choices = choices;
    console.log(dropDownMenu);
    dropDownMenu.hasActive = false;
    dropDownMenu.expanded = false;

    dropDownMenu.setShape(new createjs.Container());

    dropDownMenu.width = width;
    dropDownMenu.height = height;
    dropDownMenu.color = color;

    dropDownMenu.dropDownArrow = makeDropDownArrow();
    dropDownMenu.dropDownArrow.render(dropDownMenu.shape, {x: width-10, y: 10});
    dropDownMenu.dropDownItems = dropDownMenu.createDropDownItems(choices);

    if (typeof defaultMessage === 'undefined') {
        dropDownMenu.hasDefaultMessage = false;
        dropDownMenu.activeChoice = dropDownMenu.choices[0];
        dropDownMenu.setActiveChoice(dropDownMenu.choices[0]);
    } else {
        dropDownMenu.hasDefaultMessage = true;
        dropDownMenu.defaultMessage = defaultMessage;
        dropDownMenu.activeChoice = defaultMessage;
        dropDownMenu.defaultDDI = makeDropDownItem(defaultMessage, 
                dropDownMenu.height, dropDownMenu.width, "white", dropDownMenu);
        dropDownMenu.setActiveChoice(dropDownMenu.defaultMessage);
    }

    return dropDownMenu;
}

DropDownMenu.createDropDownItems = function(choices)
{
    var dropDownItems = [];
    var menu = this;
    for (var i=0; i < choices.length; i++) {
        var dropDownItem = makeDropDownItem(choices[i], this.height, 
                                            this.width, "white", this);
        dropDownItems.push(dropDownItem)
    }
    return dropDownItems;
}

function makeDropDownItem(itemText, menuHeight, menuWidth, menuColor, menu)
{
    var dropDownItem = Object.create(Widget);
    dropDownItem.setShape(new createjs.Container());
    dropDownItem.width = menuWidth;
    dropDownItem.height = menuHeight;
    dropDownItem.background = makeRect(menuWidth, menuHeight, menuColor, 1);
    dropDownItem.text = makeTextWidget(itemText, 12);
    dropDownItem.background.shape.x = 0;
    dropDownItem.background.shape.y = 0;
    dropDownItem.shape.addChild(dropDownItem.background.shape);
    dropDownItem.shape.addChild(dropDownItem.text.shape);
    dropDownItem.text.shape.x = 6;
    dropDownItem.text.shape.y = menuHeight/2 - 10;
    dropDownItem.dropDownMenu = menu;

    dropDownItem.shape.on("mouseover", function(event) {
        if (menu.expanded) {
            dropDownItem.background.changeColor("#f0fff0");
        }
    });

    dropDownItem.shape.on("mouseout", function(event) {
        dropDownItem.background.changeColor(dropDownItem.background.color);
    });

    dropDownItem.shape.removeAllEventListeners("click");
    dropDownItem.shape.on("click", function(evt)
    {
        if (menu.activeChoice !== this.widget.text.shape.text)
        {
            console.log("currActive: ", menu.activeChoice);
            console.log("setting active: ", this.widget.text.shape.text);
            menu.setActiveChoice(this.widget.text.shape.text);
        }
    });
    return dropDownItem;
}

DropDownMenu.getActiveChoiceItem = function()
{
    for (var i=0; i < this.dropDownItems.length; i++) {
        if (this.dropDownItems[i].text.shape.text === this.activeChoice)
        {
            return this.dropDownItems[i];
        }
    };
    if (this.activeChoice === this.defaultMessage)
    {
        return this.defaultDDI;
    }
}

DropDownMenu.disableActive = function()
{
    var menuWidget = this;
    if (typeof this.activeChoice !== "undefined")
    {
        activeChoiceItem = this.getActiveChoiceItem();
        activeChoiceItem.shape.removeAllEventListeners("click");
        activeChoiceItem.shape.on("click", function(evt)
        {
            var dropDownMenu = this.widget.dropDownMenu;
            if (dropDownMenu.activeChoice !== this.widget.text.shape.text)
            {
                console.log("currActive2: ", dropDownMenu.activeChoice);
                console.log("setting active2: ", this.widget.text.shape.text);
                dropDownMenu.setActiveChoice(this.widget.text.shape.text);
            }
        });
    }
}

DropDownMenu.setActiveChoice = function(aChoice)
{
    var menuWidget = this;
    var handleActiveItemClick = function(evt) {
        if (menuWidget.expanded) {
            var activeChoiceItem = menuWidget.getActiveChoiceItem();
            console.log("background color: ", activeChoiceItem.background.color);
            activeChoiceItem.background.changeColor(activeChoiceItem.background.color);
            menuWidget.undisplayItems();
        } else {
            var activeChoiceItem = menuWidget.getActiveChoiceItem();
            activeChoiceItem.background.changeColor("#f0fff0");
            menuWidget.displayAllItems();
        }
    };

    this.disableActive();
    this.activeChoice = aChoice;
    console.log("active choice: ", this.activeChoice);

    if (this.activeChoice === this.defaultMessage) {
        this.defaultDDI.renderW(this, {x: 0, y: 0}, "ulCorner", 0);
    } else {
        for (var i=0; i < this.dropDownItems.length; i++) {
            if (this.dropDownItems[i].text.shape.text === aChoice) {
                this.dropDownItems[i].render(this.shape, {x: 0, y: 0}, "ulCorner", 0);
            }
        }
    }

    var activeChoiceItem = menuWidget.getActiveChoiceItem();
    console.log("activeChoiceItem: ", activeChoiceItem);
    activeChoiceItem.shape.removeAllEventListeners("click");
    activeChoiceItem.shape.on("click", handleActiveItemClick);
    this.undisplayItems();
}

DropDownMenu.displayAllItems = function()
{
    this.expanded = true;
    var addNum = 0;
    for (var i=0; i < this.choices.length; i++) {
        if (this.choices[i] !== this.activeChoice) {
            addNum += 1;
            this.dropDownItems[i].render(this.shape, 
                    {x: 0, y: addNum*this.height});
        }
    };
}

DropDownMenu.undisplayItems = function()
{
    this.expanded = false;
    for (var i=0; i < this.dropDownItems.length; i++) {
        var listItem = this.dropDownItems[i];
        if (listItem.text.shape.text !== this.activeChoice) {
            this.shape.removeChild(listItem.shape);
        }
    };
    if (this.hasDefaultMessage && 
            this.defaultDDI.getParent() === this.shape) {
        this.defaultDDI.erase();
    }
    var activeChoiceItem = this.getActiveChoiceItem();
    activeChoiceItem.renderW(this, Point(0,0), "ulCorner", 0);
    console.log("background color: ", activeChoiceItem.background.color);
    activeChoiceItem.background.changeColor(activeChoiceItem.background.color);
}

DropDownMenu.clickOut = function() {
    this.undisplayItems()
}
